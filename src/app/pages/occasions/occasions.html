<div class="occasions-container">
  <!-- Header -->
  <div class="occasions-header">
    <h1>{{ "occasions.title" | translate }}</h1>
    <div class="header-controls">
      <!-- Search -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>{{ "common.search" | translate }}</mat-label>
        <input
          matInput
          [value]="searchQuery()"
          (input)="onSearchInput($event)"
          [placeholder]="'occasions.searchPlaceholder' | translate"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Type Filter -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>{{ "occasions.type" | translate }}</mat-label>
        <mat-select
          [value]="filterType()"
          (selectionChange)="filterType.set($event.value)"
        >
          <mat-option value="">{{
            "occasions.allTypes" | translate
          }}</mat-option>
          <mat-option value="birthday">{{
            "occasions.birthdays" | translate
          }}</mat-option>
          <mat-option value="anniversary">{{
            "occasions.anniversaries" | translate
          }}</mat-option>
          <mat-option value="memorial">{{
            "occasions.memorials" | translate
          }}</mat-option>
          <mat-option value="custom">{{
            "occasions.custom" | translate
          }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Add button -->
      <button
        mat-raised-button
        color="primary"
        (click)="openOccasionModal()"
        [disabled]="contactsService.contacts().length === 0"
        [matTooltip]="
          contactsService.contacts().length === 0
            ? ('occasions.addContactFirst' | translate)
            : ('occasions.addNewOccasion' | translate)
        "
      >
        <mat-icon>celebration</mat-icon>
        {{ "buttons.addOccasion" | translate }}
      </button>
    </div>
  </div>

  <!-- No contacts warning -->
  @if (contactsService.contacts().length === 0 && !occasionsService.loading()) {
  <div class="empty-state">
    <mat-icon>person_add</mat-icon>
    <p>{{ "occasions.needContacts" | translate }}</p>
    <p class="empty-subtitle">
      {{ "occasions.needContactsDesc" | translate }}
    </p>
    <a mat-raised-button color="primary" href="/contacts">
      <mat-icon>person_add</mat-icon>
      {{ "buttons.goToContacts" | translate }}
    </a>
  </div>
  } @else if (occasionsService.loading()) {
  <!-- Loading state -->
  <div class="loading-state">
    <mat-spinner diameter="48"></mat-spinner>
    <p>{{ "common.loadingOccasions" | translate }}</p>
  </div>
  } @else if (filteredOccasions().length === 0) {
  <!-- Empty state -->
  <div class="empty-state">
    @if (searchQuery() || filterType()) {
    <mat-icon>search_off</mat-icon>
    <p>{{ "occasions.noResults" | translate }}</p>
    <p class="empty-subtitle">{{ "occasions.noResultsDesc" | translate }}</p>
    <button mat-button (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      {{ "buttons.clearFilters" | translate }}
    </button>
    } @else {
    <mat-icon>celebration</mat-icon>
    <p>{{ "occasions.noOccasions" | translate }}</p>
    <p class="empty-subtitle">
      {{ "occasions.noOccasionsDesc" | translate }}
    </p>
    <button mat-raised-button color="primary" (click)="openOccasionModal()">
      <mat-icon>add</mat-icon>
      {{ "buttons.addFirstOccasion" | translate }}
    </button>
    }
  </div>
  } @else {
  <!-- Occasions count -->
  <div class="occasions-count">
    <span>{{
      "occasions.occasionCount"
        | translate : { count: filteredOccasions().length }
    }}</span>
    @if (searchQuery() || filterType()) {
    <span class="filter-info">
      @if (filterType()) { ({{ getTypeLabel(filterType()) }}) } @if
      (searchQuery()) {
      {{ "occasions.matching" | translate : { query: searchQuery() } }} }
    </span>
    }
  </div>

  <!-- Occasions grid -->
  <div class="occasions-grid">
    @for (occasion of filteredOccasions(); track occasion.id) {
    <mat-card class="occasion-card" (click)="openOccasionModal(occasion)">
      <!-- Type badge -->
      <div class="type-badge" [class]="'type-' + occasion.type">
        <mat-icon>{{ getTypeIcon(occasion.type) }}</mat-icon>
      </div>

      <mat-card-content>
        <h3 class="occasion-title">{{ occasion.title }}</h3>

        <!-- Contact name -->
        @if (occasion.contact) {
        <div class="occasion-contact">
          <mat-icon>person</mat-icon>
          <span
            >{{ occasion.contact.firstName }}
            {{ occasion.contact.lastName }}</span
          >
        </div>
        }

        <!-- Date info -->
        <div class="occasion-date">
          <mat-icon>event</mat-icon>
          <span>{{ formatDate(occasion.date) }}</span>
          @if (occasion.year && calculateYears(occasion) !== null) {
          <mat-chip class="age-chip">
            {{
              "occasions.yearsCount"
                | translate : { years: calculateYears(occasion)! }
            }}
          </mat-chip>
          }
        </div>

        <!-- Next occurrence -->
        <div class="next-occurrence">
          <mat-icon>schedule</mat-icon>
          <span>{{ getDaysUntilText(occasion) }}</span>
        </div>

        <!-- Tags -->
        <div class="occasion-tags">
          @if (occasion.repeatAnnually) {
          <mat-chip>{{ "occasions.recurring" | translate }}</mat-chip>
          } @if (occasion.reminderEnabled) {
          <mat-chip>
            <mat-icon>notifications</mat-icon>
            {{ "occasions.reminders" | translate }}
          </mat-chip>
          }
        </div>
      </mat-card-content>

      <!-- Edit indicator -->
      <div class="edit-indicator">
        <mat-icon>edit</mat-icon>
      </div>
    </mat-card>
    }
  </div>
  }
</div>
